rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

service cloud.firestore {
  match /databases/{database}/documents {
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false;
    }
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && request.auth.token.admin == true;
      return request.auth != null && request.auth.token.admin == true;
    }

    function sessionDoc(sessionId) {
      return get(/databases/$(database)/documents/sessions/$(sessionId));
    }

    function isSessionParticipant(sessionId) {
      return isSignedIn() && sessionDoc(sessionId).data.participants.hasAny([request.auth.uid]);
    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function isAdmin() {
      return isSignedIn() && userDoc(request.auth.uid).data.role == 'admin';
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function nonEmptyString(value, maxLength) {
      return value is string && value.size() > 0 && value.size() <= maxLength;
    }

    function optionalString(value, maxLength) {
      return value == null || (value is string && value.size() <= maxLength);
    }

    function validBio(bio) {
      return optionalString(bio, 500);
    }

    function validSkill(skill) {
      return skill is map
        && nonEmptyString(skill.name, 60)
        && (!('proficiency' in skill) || skill.proficiency in ['beginner', 'intermediate', 'advanced'])
        && (!('interest' in skill) || skill.interest in ['low', 'medium', 'high']);
    }

    function validSkills(skills) {
      return skills is list && skills.size() <= 20 && skills.all(skill => validSkill(skill));
    }

    function validAchievements(achievements) {
      return achievements is list
        && achievements.size() <= 25
        && achievements.all(item => item is string && item.size() <= 40);
    }

    function validGradYear(value) {
      return (value is string && value.size() == 4) || (value is int && value >= 2024 && value <= 2035);
    }

    function validPrivacy(privacy) {
      return privacy is map
        && (!('visibility' in privacy) || privacy.visibility in ['public', 'private'])
        && (!('allowRequests' in privacy) || privacy.allowRequests is bool)
        && (!('allowMessaging' in privacy) || privacy.allowMessaging is bool);
    }

    function userDoc(userId) {
      return get(/databases/$(database)/documents/users/$(userId));
    }

    function userExists(userId) {
      return exists(/databases/$(database)/documents/users/$(userId));
    }

    function userAllowsRequests(userId) {
      return userExists(userId)
        && (!('privacy' in userDoc(userId).data)
          || !('allowRequests' in userDoc(userId).data.privacy)
          || userDoc(userId).data.privacy.allowRequests == true);
    }

    function userAllowsMessaging(userId) {
      return userExists(userId)
        && (!('privacy' in userDoc(userId).data)
          || !('allowMessaging' in userDoc(userId).data.privacy)
          || userDoc(userId).data.privacy.allowMessaging == true);
    }

    function userVisibilityAllows(userId) {
      return isAdmin()
        || isOwner(userId)
        || (userExists(userId)
          && (!('privacy' in userDoc(userId).data)
            || !('visibility' in userDoc(userId).data.privacy)
            || userDoc(userId).data.privacy.visibility == 'public'));
    }

    function validUserBase(data) {
      return data.keys().hasOnly([
        'name',
        'email',
        'role',
        'gradYear',
        'createdAt',
        'offeredSkills',
        'soughtSkills',
        'achievements',
        'sessionsCompleted',
        'bio',
        'privacy'
      ])
        && nonEmptyString(data.name, 80)
        && nonEmptyString(data.email, 120)
        && validGradYear(data.gradYear)
        && data.createdAt is timestamp
        && data.offeredSkills is list
        && data.soughtSkills is list
        && validSkills(data.offeredSkills)
        && validSkills(data.soughtSkills)
        && data.achievements is list
        && validAchievements(data.achievements)
        && data.sessionsCompleted is int
        && data.sessionsCompleted >= 0
        && validBio(data.bio)
        && (!('privacy' in data) || validPrivacy(data.privacy));
    }

    function validUserCreate(data) {
      return validUserBase(data)
        && (data.role == 'student' || (data.role == 'admin' && isAdmin()));
    }

    function validUserUpdate(existingData, newData) {
      return validUserBase(newData)
        && (newData.role == existingData.role || isAdmin())
        && newData.sessionsCompleted >= existingData.sessionsCompleted;
    }

    match /users/{userId} {
      allow read: if userVisibilityAllows(userId);
      allow create: if isOwner(userId) && validUserCreate(request.resource.data);
      allow update: if (isOwner(userId) || isAdmin())
        && validUserUpdate(resource.data, request.resource.data);
      allow delete: if isAdmin();
    }

    function validSessionBase(data) {
      return data.keys().hasOnly([
        'requesterId',
        'requesterName',
        'providerId',
        'providerName',
        'skill',
        'startTime',
        'location',
        'status',
        'participants',
        'createdAt'
      ])
        && nonEmptyString(data.requesterName, 80)
        && nonEmptyString(data.providerName, 80)
        && nonEmptyString(data.skill, 80)
        && data.startTime is timestamp
        && optionalString(data.location, 120)
        && data.participants is list
        && data.participants.size() == 2
        && data.participants.hasAll([data.requesterId, data.providerId])
        && data.requesterId != data.providerId
        && data.createdAt is timestamp;
    }

    match /sessions/{sessionId} {
      allow read: if isAdmin() || (isSignedIn() && request.auth.uid in resource.data.participants);
      allow create: if isSignedIn()
        && request.resource.data.requesterId == request.auth.uid
        && validSessionBase(request.resource.data)
        && request.resource.data.status == 'pending'
        && userAllowsRequests(request.resource.data.providerId);
      allow update: if isAdmin()
        || (isSignedIn()
          && request.auth.uid in resource.data.participants
          && request.resource.data.diff(resource.data).changedKeys().hasOnly(['status'])
          && request.resource.data.status in ['pending', 'accepted', 'declined', 'completed']);
      allow delete: if isAdmin();
    }

    function validRating(data) {
      return data.keys().hasOnly([
        'sessionId',
        'raterId',
        'rateeId',
        'score',
        'comment',
        'createdAt'
      ])
        && data.sessionId is string
        && data.raterId is string
        && data.rateeId is string
        && data.raterId != data.rateeId
        && data.score is int
        && data.score >= 1
        && data.score <= 5
        && optionalString(data.comment, 500)
        && data.createdAt is timestamp;
    }

    match /ratings/{ratingId} {
      allow read: if isAdmin()
        || (isSignedIn() && (request.auth.uid == resource.data.raterId || request.auth.uid == resource.data.rateeId));
      allow create: if isSignedIn()
        && request.resource.data.raterId == request.auth.uid
        && validRating(request.resource.data)
        && exists(/databases/$(database)/documents/sessions/$(request.resource.data.sessionId))
        && get(/databases/$(database)/documents/sessions/$(request.resource.data.sessionId)).data.participants
          .hasAll([request.resource.data.raterId, request.resource.data.rateeId]);
      allow update, delete: if isAdmin();
    }

    function validMessage(data) {
      return data.keys().hasOnly([
        'sessionId',
        'fromUserId',
        'fromName',
        'body',
        'createdAt'
      ])
        && data.sessionId is string
        && data.fromUserId is string
        && nonEmptyString(data.fromName, 80)
        && nonEmptyString(data.body, 1000)
        && data.createdAt is timestamp;
    }

    match /messages/{messageId} {
      allow read: if isAdmin()
        || (isSignedIn()
          && exists(/databases/$(database)/documents/sessions/$(resource.data.sessionId))
          && request.auth.uid in get(/databases/$(database)/documents/sessions/$(resource.data.sessionId)).data.participants);
      allow create: if isSignedIn()
        && request.resource.data.fromUserId == request.auth.uid
        && validMessage(request.resource.data)
        && exists(/databases/$(database)/documents/sessions/$(request.resource.data.sessionId))
        && request.auth.uid in get(/databases/$(database)/documents/sessions/$(request.resource.data.sessionId)).data.participants
        && get(/databases/$(database)/documents/sessions/$(request.resource.data.sessionId)).data.participants
          .all(uid => userAllowsMessaging(uid));
      allow update, delete: if isAdmin();
    }

    function validClub(data) {
      return data.keys().hasOnly([
        'name',
        'description',
        'ownerId',
        'createdAt',
        'visibility'
      ])
        && nonEmptyString(data.name, 120)
        && nonEmptyString(data.description, 500)
        && data.ownerId is string
        && data.createdAt is timestamp
        && (!('visibility' in data) || data.visibility in ['public', 'private']);
    }

    match /clubs/{clubId} {
      allow read: if isAdmin()
        || (resource.data.visibility == 'public')
        || (isSignedIn() && request.auth.uid == resource.data.ownerId);
      allow create: if isSignedIn()
        && request.resource.data.ownerId == request.auth.uid
        && validClub(request.resource.data);
      allow update: if (isAdmin() || (isSignedIn() && request.auth.uid == resource.data.ownerId))
        && validClub(request.resource.data);
      allow delete: if isAdmin() || (isSignedIn() && request.auth.uid == resource.data.ownerId);
    function isAdmin() {
      return isSignedIn()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    function validSkillName(name) {
      return name is string && name.matches('^[A-Za-z0-9 .&+\\'\\-]{2,40}$');
    }

    function validSkillList(skills) {
      return skills is list && skills.size() <= 12 && skills.all(skill =>
        skill is map && skill.name is string && validSkillName(skill.name)
      );
    }

    function validBio(bio) {
      return bio is string && bio.size() <= 280;
    }

    function validClubDetails(data) {
      return data.name is string
        && data.name.size() >= 2
        && data.name.size() <= 60
        && data.description is string
        && data.description.size() <= 500
        && data.contactEmail is string
        && data.contactEmail.matches('^$|^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$')
        && data.meetingLocation is string
        && data.meetingLocation.size() <= 120
        && data.meetingSchedule is string
        && data.meetingSchedule.size() <= 120;
    }

    function canViewProfile(data, userId) {
      return data.profileVisibility == 'public'
        || (data.profileVisibility == 'members' && isSignedIn())
        || (data.profileVisibility == 'private' && isOwner(userId))
        || isAdmin();
    }

    function allowRequestsFrom(userId) {
      return userDoc(userId).data.allowRequestsFrom != 'none';
    }

    function allowMessagesFrom(userId) {
      return userDoc(userId).data.allowMessagesFrom != 'none';
    }

    match /users/{userId} {
      allow get, list: if canViewProfile(resource.data, userId);
      allow create: if isSignedIn()
        && request.auth.uid == userId
        && request.resource.data.keys().hasAll(['name', 'email', 'role', 'gradYear', 'createdAt', 'offeredSkills', 'soughtSkills', 'achievements', 'sessionsCompleted', 'profileVisibility', 'allowRequestsFrom', 'allowMessagesFrom'])
        && validSkillList(request.resource.data.offeredSkills)
        && validSkillList(request.resource.data.soughtSkills)
        && validBio(request.resource.data.bio ?? '')
        && request.resource.data.profileVisibility in ['public', 'members', 'private']
        && request.resource.data.allowRequestsFrom in ['anyone', 'none']
        && request.resource.data.allowMessagesFrom in ['participants', 'none'];
      allow update: if isOwner(userId)
        && validSkillList(request.resource.data.offeredSkills)
        && validSkillList(request.resource.data.soughtSkills)
        && validBio(request.resource.data.bio ?? '')
        && request.resource.data.profileVisibility in ['public', 'members', 'private']
        && request.resource.data.allowRequestsFrom in ['anyone', 'none']
        && request.resource.data.allowMessagesFrom in ['participants', 'none']
        && request.resource.data.role == resource.data.role;
    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function isSessionParticipant(sessionId) {
      return isSignedIn()
        && request.auth.uid in get(/databases/$(database)/documents/sessions/$(sessionId)).data.participants;
    }

    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId)
        && request.resource.data.diff(resource.data).changedKeys()
          .hasOnly(['bio', 'offeredSkills', 'soughtSkills']);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn()
        && request.auth.uid == userId
        && request.resource.data.role == resource.data.role;
      allow delete: if false;
    }

    match /sessions/{sessionId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn()
        && request.resource.data.requesterId == request.auth.uid;
      allow update, delete: if false;
    }

    match /ratings/{ratingId} {
      allow read: if isSignedIn();
      allow create, update, delete: if false;
      allow read: if isSignedIn()
        && (isAdmin() || resource.data.participants.hasAny([request.auth.uid]));
      allow create: if isSignedIn()
        && request.resource.data.requesterId == request.auth.uid
        && request.resource.data.participants.hasAny([request.auth.uid])
        && request.resource.data.status == 'pending';
      allow update, delete: if false;
    }

    match /messages/{messageId} {
      allow read: if isSignedIn()
        && (isAdmin() || isSessionParticipant(resource.data.sessionId));
      allow create: if isSignedIn() && isSessionParticipant(request.resource.data.sessionId);
      allow update, delete: if false;
      allow create: if isOwner(userId)
        && request.resource.data.email == request.auth.token.email;
      allow update: if isOwner(userId) || isAdmin();
    function isAdmin() {
      return isSignedIn()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow write: if false;
      allow read: if isSignedIn();
      allow write: if false;
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && request.auth.uid == userId;
      return isSignedIn() && request.auth.token.admin == true;
    }

    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update, delete: if isSignedIn() && (request.auth.uid == userId || isAdmin());
    }

    match /sessions/{sessionId} {
      allow read, write: if isSignedIn();
    }

    match /messages/{messageId} {
      allow read, write: if isSignedIn();
    }

    match /ratings/{ratingId} {
      allow read, write: if isSignedIn();
      allow create: if isSignedIn()
        && request.auth.uid == userId
        && request.resource.data.role == 'student';
      allow update: if (isSignedIn()
        && request.auth.uid == userId
        && request.resource.data.role == resource.data.role)
        || isAdmin();
      allow delete: if isAdmin();
    }

    match /sessions/{sessionId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isAdmin()
        || (isSignedIn() && request.auth.uid in resource.data.participants);
      allow delete: if isAdmin();
    }

    match /messages/{messageId} {
      allow read, create: if isSignedIn();
    }

    match /ratings/{ratingId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.raterId == request.auth.uid;
      allow read: if isSignedIn() && (userId == request.auth.uid || isAdmin());
      allow create: if isSignedIn() && userId == request.auth.uid;
      allow update: if isSignedIn() && userId == request.auth.uid || isAdmin();
      allow delete: if isAdmin();
    }

    match /sessions/{sessionId} {
      allow get, list: if isAdmin() || (isSignedIn() && resource.data.participants.hasAny([request.auth.uid]));
      allow create: if isSignedIn()
        && request.auth.uid == request.resource.data.requesterId
        && request.resource.data.participants.hasAll([request.resource.data.requesterId, request.resource.data.providerId])
        && request.resource.data.skill is string
        && validSkillName(request.resource.data.skill)
        && request.resource.data.location is string
        && request.resource.data.location.size() <= 120
        && allowRequestsFrom(request.resource.data.providerId);
      allow update: if isAdmin() || (isSignedIn() && resource.data.participants.hasAny([request.auth.uid]));
      allow read: if isSignedIn() && request.auth.uid in resource.data.participants;
      allow create: if isSignedIn()
        && request.resource.data.requesterId == request.auth.uid
        && request.resource.data.providerId in request.resource.data.participants
        && request.auth.uid in request.resource.data.participants
        && request.resource.data.participants.size() == 2;
      allow update: if isSignedIn()
        && request.auth.uid in resource.data.participants
        && request.resource.data.participants == resource.data.participants
        && request.resource.data.requesterId == resource.data.requesterId
        && request.resource.data.providerId == resource.data.providerId;
      allow read: if isSignedIn();
      allow create: if isSignedIn()
        && request.auth.uid in request.resource.data.participants;
      allow update: if isSignedIn()
        && request.auth.uid in resource.data.participants;
      allow delete: if false;
    }

    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && request.auth.uid == userId;
      allow delete: if isAdmin();
    }

    match /messages/{messageId} {
      allow get, list: if isAdmin() || (isSignedIn()
        && get(/databases/$(database)/documents/sessions/$(resource.data.sessionId)).data.participants.hasAny([request.auth.uid]));
      allow create: if isSignedIn()
        && request.resource.data.sessionId is string
        && request.resource.data.fromUserId == request.auth.uid
        && request.resource.data.body is string
        && request.resource.data.body.size() > 0
        && request.resource.data.body.size() <= 500
        && allowMessagesFrom(request.resource.data.fromUserId)
        && allowMessagesFrom(get(/databases/$(database)/documents/sessions/$(request.resource.data.sessionId)).data.requesterId)
        && allowMessagesFrom(get(/databases/$(database)/documents/sessions/$(request.resource.data.sessionId)).data.providerId)
        && get(/databases/$(database)/documents/sessions/$(request.resource.data.sessionId)).data.participants.hasAny([request.auth.uid]);
      allow update, delete: if isAdmin();
    }

    match /ratings/{ratingId} {
      allow get, list: if isAdmin() || (isSignedIn() && resource.data.rateeId == request.auth.uid);
      allow create: if isSignedIn()
        && request.resource.data.score is int
        && request.resource.data.score >= 1
        && request.resource.data.score <= 5
        && request.resource.data.comment is string
        && request.resource.data.comment.size() <= 300
        && get(/databases/$(database)/documents/sessions/$(request.resource.data.sessionId)).data.participants.hasAny([request.auth.uid]);
      allow update, delete: if isAdmin();
    }

    match /clubDetails/{clubId} {
      allow get, list: if isSignedIn();
      allow create, update: if isAdmin() && validClubDetails(request.resource.data);
      allow delete: if isAdmin();
    }

    match /auditLogs/{logId} {
      allow get, list: if isAdmin();
      allow create: if isSignedIn();
      allow read: if isSignedIn() && isSessionParticipant(resource.data.sessionId);
      allow create: if isSignedIn()
        && isSessionParticipant(request.resource.data.sessionId)
        && request.resource.data.fromUserId == request.auth.uid;
      allow update, delete: if false;
      allow write: if false;
    }

    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    match /messages/{messageId} {
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }
      allow write: if false;
    }

    match /clubs/{clubId} {
      allow read: if isSignedIn();
      allow write: if false;
      allow read: if isSignedIn() && (resource.data.participants.hasAny([request.auth.uid]) || isAdmin());
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (resource.data.participants.hasAny([request.auth.uid]) || isAdmin());
      allow delete: if isAdmin();
    }

    match /ratings/{ratingId} {
      allow read: if isSignedIn()
        && (isAdmin()
          || request.auth.uid == resource.data.raterId
          || request.auth.uid == resource.data.rateeId);
      allow create, update, delete: if false;
        && (request.auth.uid == resource.data.raterId
          || request.auth.uid == resource.data.rateeId);
      allow create: if isSignedIn()
        && request.resource.data.raterId == request.auth.uid
        && isSessionParticipant(request.resource.data.sessionId);
      allow update, delete: if false;
    }

    match /clubs/{clubId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin();
        && (resource.data.raterId == request.auth.uid
          || resource.data.rateeId == request.auth.uid
          || isAdmin());
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    match /messages/{messageId} {
      allow read: if isSignedIn() && (resource.data.fromUserId == request.auth.uid || isAdmin());
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    match /auditLogs/{logId} {
      allow read, write: if isAdmin();
    function userDoc(userId) {
      return get(/databases/$(database)/documents/users/$(userId));
    }

    function isAdmin() {
      return isSignedIn() && userDoc(request.auth.uid).data.role == 'admin';
    }

    function canReadProfile(userId) {
      return isAdmin()
        || (isSignedIn() && request.auth.uid == userId)
        || userDoc(userId).data.isPrivate != true
        || (isSignedIn() && request.auth.uid in userDoc(userId).data.allowedViewers);
    }

    function allowsSessionRequests(userId) {
      return userDoc(userId).data.allowSessionRequests != false;
    }

    function allowsMessages(userId) {
      return userDoc(userId).data.allowMessages != false;
    }

    function sessionDoc(sessionId) {
      return get(/databases/$(database)/documents/sessions/$(sessionId));
    }

    function isSessionParticipant(session, userId) {
      return session.data.participants.hasAny([userId]);
    }

    function recipientAllowsMessages(session, senderId) {
      return session.data.participants.size() == 2
        && (
          (session.data.participants[0] == senderId
            && allowsMessages(session.data.participants[1]))
          || (session.data.participants[1] == senderId
            && allowsMessages(session.data.participants[0]))
        );
    }

    function canReadClub(club) {
      return club.data.visibility == 'public'
        || (isSignedIn()
          && (club.data.ownerId == request.auth.uid
            || club.data.members.hasAny([request.auth.uid])));
    }

    match /users/{userId} {
      allow read: if canReadProfile(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && request.auth.uid == userId;
      allow delete: if false;
    }

    match /sessions/{sessionId} {
      allow read: if isAdmin()
        || (isSignedIn() && request.auth.uid in resource.data.participants);
      allow create: if isSignedIn()
        && request.auth.uid == request.resource.data.requesterId
        && allowsSessionRequests(request.resource.data.providerId);
      allow update: if isAdmin()
        || (isSignedIn() && request.auth.uid in resource.data.participants);
      allow delete: if false;
    }

    match /messages/{messageId} {
      allow read: if isSignedIn()
        && isSessionParticipant(sessionDoc(resource.data.sessionId), request.auth.uid);
      allow create: if isSignedIn()
        && request.auth.uid == request.resource.data.fromUserId
        && isSessionParticipant(sessionDoc(request.resource.data.sessionId), request.auth.uid)
        && recipientAllowsMessages(sessionDoc(request.resource.data.sessionId), request.auth.uid);
      allow update, delete: if false;
    }

    match /ratings/{ratingId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    match /clubs/{clubId} {
      allow read: if isSignedIn();
      allow write: if false;

      match /members/{memberId} {
        allow read: if isSignedIn();
        allow write: if false;
      }
    match /ratings/{ratingId} {
    match /messages/{messageId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    match /{document=**} {
      allow read, write: if false;
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.raterId;
      allow update, delete: if false;
    }

    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isSignedIn()
        && request.resource.data.keys().hasOnly(['action', 'userId', 'sessionId', 'targetUserId', 'timestamp'])
        && request.resource.data.action is string
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.timestamp is timestamp;
      allow update, delete: if isAdmin();
      allow create, update, delete: if false;
    }

    match /clubs/{clubId} {
      allow read: if isSignedIn();
      allow create, update, delete: if false;
      allow create: if isSignedIn()
        && (request.resource.data.userId == request.auth.uid || isAdmin());
      allow update, delete: if false;
    }
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      allow update, delete: if false;
    }

    match /clubs/{clubId} {
      allow read: if canReadClub(resource);
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.ownerId;
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.ownerId;
    }
  }
}
